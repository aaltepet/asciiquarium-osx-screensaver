#!/bin/bash

# Asciiquarium Screensaver build and development script

set -e  # Exit on error

PROJECT_NAME="Asciiquarium"
SCHEME_SCREENSAVER="AsciiquariumScreensaver"
BUILD_DIR="./build"
RELEASE_SAVER="${BUILD_DIR}/Release/AsciiquariumScreensaver.saver"
INSTALL_DIR="${HOME}/Library/Screen Savers"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Print colored output
info() {
    echo -e "${GREEN}ℹ${NC} $1"
}

warn() {
    echo -e "${YELLOW}⚠${NC} $1"
}

error() {
    echo -e "${RED}✗${NC} $1"
    exit 1
}

# Build the screensaver
build_screensaver() {
    info "Building ${SCHEME_SCREENSAVER}..."
    
    xcodebuild -project "${PROJECT_NAME}.xcodeproj" \
               -scheme "${SCHEME_SCREENSAVER}" \
               -configuration Release \
               clean build \
               ARCHS="arm64 x86_64" \
               ONLY_ACTIVE_ARCH=NO \
               SYMROOT="$(PWD)/build" \
               > /dev/null 2>&1
    
    if [ $? -eq 0 ]; then
        info "Build succeeded!"
        info "Screensaver location: ${RELEASE_SAVER}"
        
        # Verify it's a universal binary
        if file "${RELEASE_SAVER}/Contents/MacOS/${SCHEME_SCREENSAVER}" | grep -q "universal binary"; then
            info "✓ Universal binary (arm64 + x86_64)"
        else
            warn "Binary may not be universal"
        fi
    else
        error "Build failed!"
    fi
}

# Install the screensaver
install_screensaver() {
    if [ ! -d "${RELEASE_SAVER}" ]; then
        warn "Screensaver not found. Building first..."
        build_screensaver
    fi
    
    info "Installing screensaver to ${INSTALL_DIR}..."
    
    mkdir -p "${INSTALL_DIR}"
    cp -R "${RELEASE_SAVER}" "${INSTALL_DIR}/"
    
    if [ $? -eq 0 ]; then
        info "✓ Screensaver installed successfully!"
        info "You can now select it in System Settings > Screen Saver"
    else
        error "Installation failed!"
    fi
}

# Main command handler
case "$1" in
    build)
        case "$2" in
            screensaver)
                build_screensaver
                ;;
            *)
                error "Usage: ./run build screensaver"
                ;;
        esac
        ;;
    install)
        case "$2" in
            screensaver)
                install_screensaver
                ;;
            *)
                error "Usage: ./run install screensaver"
                ;;
        esac
        ;;
    *)
        echo "Usage: ./run <command> [options]"
        echo ""
        echo "Commands:"
        echo "  build screensaver              Build the screensaver"
        echo "  install screensaver           Install the screensaver (builds if needed)"
        exit 1
        ;;
esac

